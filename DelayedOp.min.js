(function(){var j,e,i=Object.prototype.hasOwnProperty,k=function(a,b){function f(){this.constructor=a}for(var c in b)i.call(b,c)&&(a[c]=b[c]);f.prototype=b.prototype;a.prototype=new f;a.__super__=b.prototype;return a};j=function(){function a(b,f){var c;this.name=b;this.cb=f;if(null==this.cb)c=["<Anonymous>",this.name],this.name=c[0],this.cb=c[1];this.total=0;this.tags={};a.addOp(this);this.wait(a.ready_tag)}a.prototype.wait=function(b,a){var c,d,g=this;null==b&&(b="");"function"===typeof b&&(d=["",
b],b=d[0],a=d[1]);if(null==(d=this.tags)[b])d[b]=0;this.tags[b]++;this.total++;null!=a&&(c=function(){g.ok(b);return c=function(){throw new e(b);}},a(function(){return c()}))};a.prototype.ok=function(b){var a;null==b&&(b="");if(null==(a=this.tags)[b])a[b]=0;this.tags[b]--;if(0>this.tags[b])throw new e(b);if(!--this.total)return this.fire()};a.prototype.done=function(){return this.ok(a.ready_tag)};a.prototype.fire=function(){this.cb();return a.removeOp(this)};a.prototype.pendingTags=function(){var b,
a,c,d;c=this.tags;d=[];for(a in c)i.call(c,a)&&(b=c[a])&&d.push(a);return d};a.logPending=function(){var b,a,c,d,g,h,e;c="";h=this.pending_ops;for(b in h)if(i.call(h,b)){a=h[b];c+=""+a.name+":\n";e=a.pendingTags();for(d=0,g=e.length;d<g;d++)a=e[d],c+="    '"+a+"'\n"}return console.log(c)};a.pending_ops={};a.next_id=0;a.addOp=function(a){return this.pending_ops[a.id=this.next_id++]=a};a.removeOp=function(a){return delete this.pending_ops[a.id]};a.ready_tag="__reserved_ready";return a}();e=function(a){function b(a){this.message=
"ok() callback called too many times (tag: '"+a+"') "}k(b,a);b.prototype.name="DelayedOpError";return b}(Error);("undefined"!==typeof exports&&null!==exports?exports:this).DelayedOp=j}).call(this);
